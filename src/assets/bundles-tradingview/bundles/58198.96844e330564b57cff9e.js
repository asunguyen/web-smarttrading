"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[58198],{359663:(e,t,s)=>{s.d(t,{FeatureToggleWatchedValue:()=>r});var n=s(125226),i=s(129025);class r extends i.WatchedValue{constructor(e,t){super(function(e,t){return(0,n.isFeatureEnabled)(e)}(e)),(0,n.onFeaturesStateChanged)().subscribe(this,(t=>{e===t&&this.setValue((0,n.isFeatureEnabled)(e))}))}destroy(){(0,n.onFeaturesStateChanged)().unsubscribeAll(this),super.destroy()}}},526225:(e,t,s)=>{s.r(t),s.d(t,{syncUserConversionData:()=>f,syncUserData:()=>c});var n=s(201089),i=s(345848),r=s(120780),a=s(290576);const o=(0,n.getLogger)("User.Sync");function l(e){return`${e}_${window.user&&window.user.username||""}`}function u(e,t,s,n=!0){s!==window.user.pro_plan&&(window.user.pro_plan=s,window.user.is_pro=Boolean(s),(0,i.trackEvent)("Sync User Data","Different Pro Plan",l(e))),t!==window.is_authenticated&&(window.is_authenticated=t,n&&window.loginStateChange.fire(),(0,i.trackEvent)("Sync User Data","Different Auth",l(e)))}async function c(e){try{u(e,!0,(await(0,a.getProPlanDetailsForUser)()).pro_plan)}catch(t){!function(e,t){403===t.status&&["not_authenticated","login_required"].includes(t.type||"")?u(e,!1,void 0):o.logError(t.message)}(e,t)}}async function f(e,t=!0){var s;const n=new URL("/pricing/",window.location.origin),i=new URLSearchParams(window.location.search);i.has("_test_country")&&n.searchParams.append("_test_country",null!==(s=i.get("_test_country"))&&void 0!==s?s:"");const a=await(0,r.fetch)(n.href),o=await a.json();return u(e,o.is_authenticated,o.user.pro_plan,t),o}},224004:(e,t,s)=>{s.r(t),s.d(t,{getUnreadFireControlsBuffer:()=>A,getUnreadFiresBuffer:()=>y});var n=s(895171),i=s(226722),r=(s(659863),s(125226)),a=s(171983),o=s(993948),l=s(919892),u=s(685459),c=s.n(u),f=s(484156),_=s(729584),d=s(201089),h=s(266325);const g=(0,d.getLogger)("Alerts.ClearOfflineEventsMerger");class m{constructor(e,t,s){this._mergedIds=new Set,this._abortController=null,this._delay=e,this._apiCallback=t,this._offlineEventName=s}mergeRequest(e){if(e.forEach((e=>this._mergedIds.add(e))),this._abortController)return void g.logDebug(`Merge request for ${this._offlineEventName} has already been scheduled`);this._abortController=new AbortController;const t=this._abortController.signal,s=async()=>{var e;await(e=this._delay,new Promise((t=>{setTimeout(t,e)}))),t.aborted||await this._apiCallback({alert_ids:Array.from(this._mergedIds)})};let n;navigator.locks?(g.logNormal(`Trying to merge ${this._offlineEventName} clear requests using Web Locks API`),n=navigator.locks.request("alerts-offline-clear-requests-lock",{ifAvailable:!0},(e=>{if(e)return(0,h.respectAbort)(t,s());g.logDebug(`Lock to merge ${this._offlineEventName} clear requests has already been acquired`)}))):(g.logNormal(`Trying to merge ${this._offlineEventName} clear requests without Web Locks API`),n=(0,h.respectAbort)(t,s()));const i=Array.from(this._mergedIds);n.then((()=>{g.logNormal(`Successfully cleared ${this._offlineEventName} for alert ids ${i}`)})).catch((e=>{(0,
h.isAbortError)(e)||g.logError(`Failed to clear ${this._offlineEventName} for alert ids ${i}: ${e}`)})).finally((()=>{this._abortController=null,this._mergedIds.clear()}))}undoRequest(){var e;null===(e=this._abortController)||void 0===e||e.abort(),this._abortController=null,this._mergedIds.clear()}}const b=(0,d.getLogger)("Alerts.UnreadBuffers");class v extends(c()){constructor(e,t,s){super(),this._abortController=new AbortController,this._requestsAllowed=!0,this._notClearedEvents=[],this._notifications={},this._restApi=e,this._pushApi=t,this._classNameForLogger=s,this._unsubscribePushApi=this._subscribePushApi(this._pushApi),this._clearOfflineEventsMerger=new m(1e3,this._getClearOfflineEventsCallback(this._restApi),this._classNameForLogger)}async requestOfflineEvents(){if(this._requestsAllowed)return(0,h.respectAbort)(this._abortController.signal,this._restApiGetOfflineEvents(this._restApi).then((e=>{this._processOfflineEvents(e,this._notifications)})).catch((e=>{const t=e instanceof Error?e.message:String(e);b.logError(`Getting offline ${this._classNameForLogger} failed, error: ${t}`)})))}allowRequests(){this._requestsAllowed=!0}preventRequests(){this._requestsAllowed=!1,this._abortRequests()}destroy(){(0,_.assertNoEmitterListeners)(this,["add","remove"]),this._abortRequests(),this._unsubscribePushApi()}markRead(e){const t=new Set;for(const s of e)this._notifications[s]&&t.add(s);if(t.size){const e=Array.from(t);this._notifications=(0,f.default)(this._notifications,e),this.emit("remove",e);const s=[...this._notClearedEvents,...e];this._requestsAllowed?this._clearOfflineEventsMerger.mergeRequest(s):this._notClearedEvents=s}}value(){return this._notifications}_addNotifications(e){this._notifications={...this._notifications,...e},this.emit("add",e)}_abortRequests(){this._abortController.abort(),this._abortController=new AbortController,this._clearOfflineEventsMerger.undoRequest()}}function w(e,t=!1){const s=e.latest_fire;return{isOffline:t,firesCount:e.fires_count,latestFire:{fireId:s.fire_id,alertId:s.alert_id,resolution:s.resolution,description:s.message,soundFile:s.sound_file,soundDuration:s.sound_duration,popup:s.popup,crossInterval:s.cross_interval,name:s.name,symbol:(0,l.decodeExtendedSymbol)(s.symbol),fireTime:new Date(s.fire_time),barTime:new Date(s.bar_time)}}}function p(e){return{alertId:e.alert_id,symbol:(0,l.decodeExtendedSymbol)(e.symbol),description:e.message,name:e.name}}const y=E(class extends v{constructor(e,t){super(e,t,"fires")}_getClearOfflineEventsCallback(e){return e.clearOfflineFires.bind(e)}_subscribePushApi(e){const t=e=>{var t,s;const n=null!==(s=null===(t=this.value()[e.alert_id])||void 0===t?void 0:t.firesCount)&&void 0!==s?s:0,i={[e.alert_id]:w({fires_count:n+1,latest_fire:e})};this._addNotifications(i)},s=e=>{this.markRead(e)};return e.on("alert_fired",t),e.on("alerts_deleted",s),()=>{e.off("alert_fired",t),e.off("alerts_deleted",s)}}_restApiGetOfflineEvents(e){return e.getOfflineFires()}_processOfflineEvents(e,t){const s={};for(const n of e){const e=n.latest_fire.alert_id;t[e]?s[e]={
isOffline:!0,firesCount:t[e].firesCount+n.fires_count,latestFire:t[e].latestFire}:s[e]=w(n,!0)}Object.keys(s).length&&this._addNotifications(s)}},"alerts-unread-fires-buffer"),A=E(class extends v{constructor(e,t){super(e,t,"fire controls")}_getClearOfflineEventsCallback(e){return e.clearOfflineFireControls.bind(e)}_subscribePushApi(e){const t=e=>{const t={};for(const s of e)s.active||"fire_control"!==s.last_stop_reason||(t[s.alert_id]=p({alert_id:s.alert_id,symbol:s.symbol,name:s.name,message:s.message}));Object.keys(t).length>0&&this._addNotifications(t)};return e.on("alerts_updated",t),()=>{e.off("alerts_updated",t)}}_restApiGetOfflineEvents(e){return e.getOfflineFireControls()}_processOfflineEvents(e,t){const s={};for(const n of e)t[n.alert_id]||(s[n.alert_id]=p(n));Object.keys(s).length>0&&this._addNotifications(s)}},"alerts-unread-fire-controls-buffer");function E(e,t){return(0,n.default)((()=>{const s=(0,r.isFeatureEnabled)("alerts-use-pricealerts-pushstream-for-notifications")?"pricealerts":"alert",n=new e((0,a.getAlertsRestApi)(),(0,o.getAlertsPushApi)(s));return function(e,t,s){const n=`${s}.remove`;function i(e){t.emit(n,JSON.stringify(e))}function r(t){e.markRead(JSON.parse(t))}e.on("remove",i),t.on(n,r)}(n,i.TVXWindowEvents,t),n}))}},594949:(e,t,s)=>{s.d(t,{getAlertSession:()=>n.getAlertSession,getAlertsTrackers:()=>i.getAlertsTrackers});var n=s(908287),i=s(206242)},206242:(e,t,s)=>{s.r(t),s.d(t,{getAlertsTrackers:()=>u});var n=s(895171),i=s(359663),r=(s(659863),s(694839)),a=s(129025);class o{constructor(e,t){this._unsetMaintenanceTimeoutId=null,this._onAliveMaintenanceChange=e=>{if(e)this._clearMaintenanceUnsetTimeout(),this._lastMaintenanceUnsetReason=null,this._state.setValue(!0);else if(this._config.autoUnsetMaintenanceTimeout){const e=this._config.autoUnsetMaintenanceTimeout;this._unsetMaintenanceTimeoutId=setTimeout((()=>this._syncMaintenanceState("timeout")),(t=e.from,s=e.to,Math.floor(Math.sqrt(Math.random())*(s-t)+t)))}var t,s},this._maintenanceValue=e,this._config=t,this._state=new a.WatchedValue(this._maintenanceValue.value()),this._lastMaintenanceUnsetReason=this._state.value()?null:"initial_operated",this._maintenanceValue.subscribe(this._onAliveMaintenanceChange)}destroy(){this._clearMaintenanceUnsetTimeout(),this._maintenanceValue.unsubscribe(this._onAliveMaintenanceChange)}value(){return this._state.value()}syncOnUserAction(){this._syncMaintenanceState("user_action")}subscribe(e){this._state.subscribe(e)}unsubscribe(e){this._state.unsubscribe(e)}lastMaintenanceUnsetReason(){return this._lastMaintenanceUnsetReason}_syncMaintenanceState(e){this._clearMaintenanceUnsetTimeout();const t=this._state.value(),s=this._maintenanceValue.value();t!==s&&(this._lastMaintenanceUnsetReason=s?null:"user_action"===e?"user_action":"auto_unset",this._state.setValue(s))}_clearMaintenanceUnsetTimeout(){this._unsetMaintenanceTimeoutId&&(clearTimeout(this._unsetMaintenanceTimeoutId),this._unsetMaintenanceTimeoutId=null)}}class l{constructor(e){this._setOfflineTimeout=null,this._onOnline=()=>{
this._clearSetOfflineTimeout(),this._state.setValue(!1)},this._onOffline=()=>{this._setOfflineTimeout=setTimeout((()=>this._syncOfflineState()),1e4)},this._isOffline=e,this._state=new a.WatchedValue(this._isOffline()),window.addEventListener("online",this._onOnline),window.addEventListener("offline",this._onOffline)}value(){return this._state.value()}subscribe(e){this._state.subscribe(e)}unsubscribe(e){this._state.unsubscribe(e)}destroy(){this._clearSetOfflineTimeout(),window.removeEventListener("online",this._onOnline),window.removeEventListener("offline",this._onOffline)}_syncOfflineState(){this._clearSetOfflineTimeout(),this._state.setValue(this._isOffline())}_clearSetOfflineTimeout(){this._setOfflineTimeout&&(clearTimeout(this._setOfflineTimeout),this._setOfflineTimeout=null)}}const u=(0,n.default)((()=>{const e=new i.FeatureToggleWatchedValue("alerts-maintenance",!1),t=(0,r.getAlertConfig)(),s=new o(e,t),n=new l((()=>!window.navigator.onLine));return{maintenance:s,offline:n,anyTrackerFired:()=>s.value()||n.value()}}))},290576:(e,t,s)=>{s.d(t,{getProPlanDetailsForUser:()=>d,isExpertFeature:()=>_});var n=s(822122),i=s(740254),r=s(255453),a=s(120780),o=s(526698);function l(e){return window.pro?e===n.ProPlans.Free?-1:window.pro.getProduct((0,r.getProductForTrial)(e)).upgrade_weight:0}function u(e){return window.pro?window.pro.getProduct((0,r.getProductForTrial)(e)).upgrade_weight:0}function c(e){return function(e){return e.sort(((e,t)=>l(e)-l(t)))}((0,i.getProPlansWithFeature)(e).filter((e=>!(0,r.isTrialProduct)(e))))[0]||null}function f(e){return function(e){return e.sort(((e,t)=>u(e)-u(t)))}((0,i.getExpertPlansWithFeature)(e))[0]||null}function _(e){const t=f(e),s=c(e);return Boolean(t)&&!Boolean(s)}async function d(){const e=await(0,a.fetch)("/pro-plans/profile/"),t=await e.json();if(e.ok)return t;if(403===e.status){const s=t;throw new o.ApiError(s.detail,e.status,s.code)}throw new Error(`Unable to handle unexpected response: ${String(e.text())}`)}}}]);